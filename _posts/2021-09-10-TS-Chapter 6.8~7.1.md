---
title: "[토비의 스프링] Week10(6.8~7.1)"
subtitle: 토비의 스프링 10주차
date: 2021-09-10 20:23:24 +0900
author: taxol
toc: 
categories: 토비의_스프링
tags:
  - 토비의_스프링
toc: true
toc_sticky: true
---

> 토비의 스프링 3.1 Chapter 6.8 ~ 7.1

# Chapater 6.8
## 선언적 트랜잭션과 트랜잭션 전파속성
- 선언적 트랜잭션과(declarative transaction)  
AOP를 이용해 코드 외부에서 트랜잭션의 기능을 부여해주고 속성을 지정할 수 있게 하는 방법  
- 프로그램에 의한 트랜잭션(programmatic transaction)  
TransactionTemplate이나 개별 데이터 기술의 트랜잭션 API를 사용해 적접 코드 안에서 사용하는 방법  

## 트랜잭션 동기화와 테스트
트랜잭션의 전파와 그로인한 유연한 개발의 배경은 AOP가 있었다.  
하지만, AOP를 통한 선언적 트랜잭션이나 트랜잭션 전파를 가능하게 한 것은 트랜잭션 추상화이다.  

트랜잭션 추상화 핵심은 트랜잭션 매니저와 트랜잭션 동기화이다.  
- 트랜잭션 메니저를 통해 구체적인 트랜잭션 기술의 종류에 상관없이 일관된 트랜잭션 제어가 가능  
- 트랜잭션 동기화를 통해 트랜잭션 정보를 저장소에 보관해뒀다가 DAO에서 공유 or 트랜잭션 전파 속성 참여 가능  

### 트랜잭션 매니저를 이용한 테스트용 트랜잭션 제어
| 여러 개의 트랜잭션을 하나로 통합할 수 없을까?  
여러 개의 메소드 모두 트랜잭션 전파 속성이 REQUIRED이면, 이 메소드들이 호출되기 전에 트랜잭션이 시작되게만 한다면 가능  

### 롤백 테스트  
| 테스트 내의 모든 DB 작업을 하나의 트랜잭션 안에서 동작하게 하고 테스트가 끝나면 무조건 롤백해버리는 테스트  

롤백 테스트는 DB 작업이 포함된 테스트가 수행돼도 DB에 영향을 주지 않기 때문에 장점이 많다.  
롤백 테스트는 테스트를 진행하는 동안에 조작한 데이터를 모두 롤백하고 테스트를 시작하기 전 상태로 만들어주기 때문에 유용  

- 여러 개발자가 하나의 공용 테스트 DB도 사용 가능하게 한다.  
- DB에 따라 트랜잭션을 롤백하면 커밋할 때 보다 성능이 더 향상된다.  
## 테스트를 위한 트랜잭션 애노테이션  
- @Transactional  
테스트용 @Transactional은 기본적으로 트랜잭션을 강제 롤백시키도록 설정되어 있다.  

- @Rollback   
트랜잭션을 커밋시켜서 테스트에서 진행한 작업을 그대로 DB에 반영하고 싶을 때 @Rollback(false) 사용    
메소드 레벨에만 적용 가능  

- @TransactionConfiguraiton  
클래스 레벨에 사용 가능    
@TransactionConfiguraiton을 사용하면 롤백에 대한 공통 속성을 지정할 수 있다.   

### NotTransactional과 Propagation.NEVER
@NotTransactional을 테스트 메소드에 부여하면 클래스 레벨의 @Transactional을 무시하고 트랜잭션을 시작하지 않은 채로 테스트를 진행  
@NotTransactional 대신 전파 속성을 Propagation.NEVER로 설정 가능  

### 효과적인 DB 테스트  
단위 테스트와 통합 테스트는 클래스를 구분하는 것이 좋음  
DB가 사용되는 통합 테스트를 별도의 클래스로 만들어둔다면 기본적으로 클래스 레벨에 @Transactional을 부여  